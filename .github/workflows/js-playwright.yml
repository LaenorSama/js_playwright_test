# –ù–∞–∑–≤–∞–Ω–∏–µ workflow
name: testops_playwright_test
# run-name: ${{ github.actor }} is creating Allure report üöÄ

# –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
env:
    ALLURE_ENDPOINT: https://demo.qatools.cloud/
    ENDPOINT: https://demo.qatools.cloud/
    ALLURE_PROJECT_ID: 165
    ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
    #ALLURE_JOB_RUN_ID: ${{ github.event.inputs.ALLURE_JOB_RUN_ID }}
    ALLURE_RESULTS: "./out/allure-results"
    BROWSER: ${{ inputs.BROWSER || 'OperaGX' }}
    OS: ${{ inputs.OS || 'Win_11' }}
    #LAUNCH_TYPE: ${{ inputs.LAUNCH_TYPE || 'push' }}
    #BRANCH: ${{ github.ref_name }}
on:
 #–ø—É—à –∏ –ø—É–ª–ª —Ä–µ–∫–≤–µ—Å—Ç
  push:
     branches:
      - main
  pull_request:
    branches:
      - main
  #push:
  #  branches-ignore:
  #    - '!main'

# –≤—Ä—É—á–Ω—É—é    
  workflow_dispatch:
    inputs:
      ENDPOINT:
        description: "Endpoint"
        required: false
        default: "https://demo.qatools.cloud/"
      BROWSER:
        description: Browser
        required: false
        default: "OperaGX"
      OS:
        description: OS
        required: false
        default: "Win_11"
      #LAUNCH_TYPE:
      #  description: LAUNCH_TYPE
      #  required: false
      #  default: "manual"
      ALLURE_JOB_RUN_ID:
        description: "ALLURE_JOB_RUN_ID - service parameter (leave blank)"
        required: false
        default: ""
      ALLURE_USERNAME:
        description: "ALLURE_USERNAME - service parameter (leave blank)"
        required: false
        default: ""
      BRANCH:
        description: "Git branch (filled automatically)"
        required: false
        default: ""



permissions: write-all

jobs:
  autotests:
    name: Run tests and generate Allure Report 
    runs-on: ubuntu-latest

    # —É–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ç–∫—É –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫—Ñ–ª–æ—É
    env:
      BRANCH: ${{ inputs.BRANCH != '' && inputs.BRANCH || github.ref_name }}
      #BRANCH: ${{ github.ref_name }}
      
    steps:
    # —á–µ–∫–∞—É—Ç
      - name: Clone repository
        uses: actions/checkout@v4.2.2

    # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ node.js –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Set up Node 20
        uses: actions/setup-node@v4.1.0
        with:
          node-version: 20
          cache: npm

      - name: Install npm
        run: npm install
        
      - name: install allure-playwright
        run: npm install allure-playwright --save-dev

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º allurectl
      - name: Install allurectl
        uses: allure-framework/setup-allurectl@v1
        with:
          allure-endpoint: ${{ env.ALLURE_ENDPOINT }}
          allure-token: ${{ env.ALLURE_TOKEN }}
          allure-project-id: ${{ env.ALLURE_PROJECT_ID }}
      
      - name: remove old directoryes
        run:
          rm -rf allure-results .allure  

      #- name: start playwright test
      # run: |
      #    npx playwright test 
      #    continue-on-error: true
          
      - name: Run tests with Allure TestOps
        run: allurectl watch -- npm test
        continue-on-error: true
        env:
            BRANCH: ${{ github.ref_name }}
            ENDPOINT: ${{ env.ALLURE_ENDPOINT }}
            BROWSER: ${{ github.event.inputs.BROWSER}}
            OS: ${{ github.event.inputs.OS}}
            ALLURE_JOB_RUN_ID: ${{ github.event.inputs.ALLURE_JOB_RUN_ID }}
    
      #- name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å allurectl
      #  run: allurectl watch -- npx playwright test --no-testplan 
      #  env:
      #      BRANCH: ${{ github.ref_name }}
      #      ENDPOINT: ${{ env.ALLURE_ENDPOINT }}
      #      BROWSER: ${{ github.event.inputs.BROWSER}}
      #      OS: ${{ github.event.inputs.OS}}
